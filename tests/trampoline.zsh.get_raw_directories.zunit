#!/usr/bin/env zunit

@setup {
  load './_support/uuid.zsh'
  export XDG_CONFIG_HOME="$HOME/$uuid"
  mkdir -p "$XDG_CONFIG_HOME/zt"
  echo '/tmp/dir1' >> "$XDG_CONFIG_HOME/zt/config.csv"
  echo '/tmp/dir2' >> "$XDG_CONFIG_HOME/zt/config.csv"
  echo '/tmp/dir3' >> "$XDG_CONFIG_HOME/zt/config.csv"
  echo '/tmp/ldir1' >> "$XDG_CONFIG_HOME/zt/config_local.csv"
  echo '/tmp/ldir2' >> "$XDG_CONFIG_HOME/zt/config_local.csv"
  load '../trampoline.zsh'
}

@teardown {
  rm "$HOME/$uuid/zt/config.csv"
  rm "$HOME/$uuid/zt/config_local.csv"
  rmdir "$HOME/$uuid/zt"
  rmdir "$HOME/$uuid"
}

@test 'zt_get_raw_directories_main gets main raw directories' {
  # exercise
  run zt_get_raw_directories_main
  # verify
  assert $state equals 0
  assert $output is_not_empty
  assert ${#lines[@]} equals 3
  assert ${lines[1]} same_as '/tmp/dir1'
  assert ${lines[2]} same_as '/tmp/dir2'
  assert ${lines[3]} same_as '/tmp/dir3'
}

@test 'zt_get_raw_directories_local gets local raw directories' {
  # exercise
  run zt_get_raw_directories_local
  # verify
  assert $state equals 0
  assert $output is_not_empty
  assert ${#lines[@]} equals 2
  assert ${lines[1]} same_as '/tmp/ldir1'
  assert ${lines[2]} same_as '/tmp/ldir2'
}

@test 'zt_get_raw_directories_all gets all raw directories' {
  # exercise
  run zt_get_raw_directories_all
  # verify
  assert $state equals 0
  assert $output is_not_empty
  assert ${#lines[@]} equals 5
  assert ${lines[1]} same_as '/tmp/dir1'
  assert ${lines[2]} same_as '/tmp/dir2'
  assert ${lines[3]} same_as '/tmp/dir3'
  assert ${lines[4]} same_as '/tmp/ldir1'
  assert ${lines[5]} same_as '/tmp/ldir2'
}
